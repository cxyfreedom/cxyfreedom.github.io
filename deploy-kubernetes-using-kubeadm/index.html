<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>使用 kubeadm 安装 Kubernetes 1.12 - Field of Hope</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="CxyFreedom" /><meta name="description" content="kubeadm 是 Kubernetes 官方提供的用于快速部署 Kubernetes 集群的工具，本文主要记录自己通过 kubeadm 部署 Kubernetes 过程中遇到的问题和踩过的坑，便于自己和他人查阅。
" /><meta name="keywords" content="Hugo, theme, even, cxyfreedom, 博客, blog, reishin, python, BackEnd" />



<meta name="google-site-verification" content="BXyY8kRGyP8O8dUaJk8XURntqXDjfgU5O9tBzPegieI" />


<meta name="generator" content="Hugo 0.110.0 with theme even" />


<link rel="canonical" href="https://reishin.me/deploy-kubernetes-using-kubeadm/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="使用 kubeadm 安装 Kubernetes 1.12" />
<meta property="og:description" content="kubeadm 是 Kubernetes 官方提供的用于快速部署 Kubernetes 集群的工具，本文主要记录自己通过 kubeadm 部署 Kubernetes 过程中遇到的问题和踩过的坑，便于自己和他人查阅。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://reishin.me/deploy-kubernetes-using-kubeadm/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-11-22T17:26:21+08:00" />
<meta property="article:modified_time" content="2018-11-22T17:26:21+08:00" />
<meta itemprop="name" content="使用 kubeadm 安装 Kubernetes 1.12">
<meta itemprop="description" content="kubeadm 是 Kubernetes 官方提供的用于快速部署 Kubernetes 集群的工具，本文主要记录自己通过 kubeadm 部署 Kubernetes 过程中遇到的问题和踩过的坑，便于自己和他人查阅。"><meta itemprop="datePublished" content="2018-11-22T17:26:21+08:00" />
<meta itemprop="dateModified" content="2018-11-22T17:26:21+08:00" />
<meta itemprop="wordCount" content="5341">
<meta itemprop="keywords" content="Kubernetes,kubeadm," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用 kubeadm 安装 Kubernetes 1.12"/>
<meta name="twitter:description" content="kubeadm 是 Kubernetes 官方提供的用于快速部署 Kubernetes 集群的工具，本文主要记录自己通过 kubeadm 部署 Kubernetes 过程中遇到的问题和踩过的坑，便于自己和他人查阅。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Field of Hope</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="https://hacknical.com/cxyfreedom/resume?locale=zh">
        <li class="mobile-menu-item">简历</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Field of Hope</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://hacknical.com/cxyfreedom/resume?locale=zh">简历</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">使用 kubeadm 安装 Kubernetes 1.12</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-11-22 17:26 </span>
        <div class="post-category">
            <a href="/categories/DevOps/"> DevOps </a>
            </div>
          <span class="more-meta"> 约 5341 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#准备">准备</a></li>
        <li><a href="#系统配置">系统配置</a></li>
        <li><a href="#安装docker">安装Docker</a></li>
        <li><a href="#使用-kubeadm-部署">使用 kubeadm 部署</a></li>
        <li><a href="#安装常用组件">安装常用组件</a></li>
        <li><a href="#参考资料">参考资料</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>【注意】最后更新于 <span class="timeago" datetime="2018-11-22T17:26:21" title="November 22, 2018">November 22, 2018</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
    <div class="post-content">
      <p>kubeadm 是 Kubernetes 官方提供的用于快速部署 Kubernetes 集群的工具，本文主要记录自己通过 kubeadm 部署 Kubernetes 过程中遇到的问题和踩过的坑，便于自己和他人查阅。</p>
<h3 id="准备">准备</h3>
<p>k8s至少需要一个 <code>master</code> 节点和一个 <code>node</code> 节点才能组成一个可用的集群。</p>
<p>本文搭建一个 <code>master</code> 节点和一个 <code>node</code> 节点。</p>
<ul>
<li>主机环境：Mac OS Sierra</li>
<li>虚拟机环境：<code>CentOS 7.5</code></li>
<li>虚拟机工具 <code>vagrant</code> + <code>VirtualBox</code></li>
</ul>
<p>创建两台虚拟机，IP和主机名分别如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">10.0.0.100 k8s-master
</span></span><span class="line"><span class="cl">10.0.0.111 k8s-node1
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务器系统均为 <code>CentOS/7</code></p>
<blockquote>
<p>使用 vagrant 创建虚拟机可以参考 <a href="http://www.cnblogs.com/xishuai/p/macos-use-vagrant-with-virtualbox.html">Mac OS 使用 Vagrant 管理虚拟机（VirtualBox）</a></p>
</blockquote>
<p>注意：Kubernetes 几乎所有的安装组件和 Docker 镜像都放在 google 自己的网站上，这对国内的同学可能是个不小的障碍。建议是：网络障碍都必须想办法克服，不然连 Kubernetes 的门都进不了。</p>
<p>参考文章</p>
<ul>
<li><a href="https://blog.csdn.net/qianghaohao/article/details/80383434">Shadowsocks + Privoxy 搭建 http 代理服务</a></li>
<li><a href="https://my.oschina.net/tinkercloud/blog/638960">centos7 docker使用https_proxy 代理配置</a></li>
</ul>
<h3 id="系统配置">系统配置</h3>
<h4 id="修改主机名">修改主机名</h4>
<p>分别使用 <code>hostname</code> 把主机名称设置为 <code>k8s-master</code> 和 <code>k8s-node1</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">hostnamectl set-hostname k8s-master
</span></span><span class="line"><span class="cl">hostnamectl set-hostname k8s-node1
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后修改每一台主机的 hosts</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim /etc/hosts
</span></span><span class="line"><span class="cl"><span class="c1"># 加入以下内容</span>
</span></span><span class="line"><span class="cl">10.0.0.100 k8s-master
</span></span><span class="line"><span class="cl">10.0.0.101 k8s-node1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="开放端口">开放端口</h4>
<p>如果各个主机启用了防火墙， 需要开放 Kubernetes 各个组件所需要的端口，可以查看 <a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/#check-required-ports">Installing kubeadm</a>中的“Check required ports”一小节。这里为了方便起见在各个节点直接禁用防火墙：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">systemctl stop firewalld
</span></span><span class="line"><span class="cl">systemctl disable firewalld
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>如果在生产环境，不建议直接关闭防火墙。只需要把需要的端口开放即可。</p>
</blockquote>
<h4 id="禁用-selinux">禁用 SELINUX</h4>
<p>目的是让容器可以读取主机文件系统</p>
<p><strong>临时方法</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">setenforce <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>永久方法</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim /etc/selinux/config
</span></span><span class="line"><span class="cl"><span class="c1"># 修改以下内容后，重启服务器</span>
</span></span><span class="line"><span class="cl"><span class="nv">SELINUX</span><span class="o">=</span>disabled
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="开启-iptables">开启 iptables</h4>
<p>创建 <code>/etc/sysctl.d/k8s.conf</code> 文件并添加相关内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后执行下面命令即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sysctl --system
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>实际可以参考官方文档<a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">Installing kubeadm, kubelet and kubectl</a>一小节中的内容</p>
</blockquote>
<h4 id="关闭系统-swap">关闭系统 swap</h4>
<p>Kubernetes 1.8 开始要求关闭系统的Swap，如果不关闭，默认配置下 kubelet 将无法启动。
可以通过 kubelet 的启动参数 <code>--fail-swap-on=false</code> 更改这个限制。</p>
<p><strong>方法一</strong></p>
<p>此方法是直接关闭系统的 Swap</p>
<p>首先执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">swapoff -a
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后修改 <code>/etc/fstab</code> 文件，注释掉 SWAP 的自动挂载，防止机子重启后 swap 启用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vi /etc/fstab
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /etc/fstab</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Created by anaconda on Wed Feb 28 17:48:43 2018</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Accessible filesystems, by reference, are maintained under &#39;/dev/disk&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">/dev/mapper/VolGroup00-LogVol00 /                       xfs     defaults        <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>df1e67ab-46b0-4b49-a861-e7d10736d467 /boot                   xfs     defaults        <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">/dev/mapper/VolGroup00-LogVol01 swap                    swap    defaults        <span class="m">0</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注释 swap 这一行后保存退出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># /dev/mapper/VolGroup00-LogVol01 swap                    swap    defaults        0 0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>确认 swap 是否已经关闭，执行命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">free -m
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c1"># free -m</span>
</span></span><span class="line"><span class="cl">              total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">Mem:           <span class="m">1838</span>         <span class="m">670</span>         <span class="m">134</span>           <span class="m">9</span>        <span class="m">1033</span>         <span class="m">946</span>
</span></span><span class="line"><span class="cl">Swap:             <span class="m">0</span>           <span class="m">0</span>           <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>swap为0说明已经关闭。</p>
<p>接着调整 <code>/etc/sysctl.d/k8s.conf</code> 配置文件的 <code>swappiness</code> 参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vi /etc/sysctl.d/k8s.conf
</span></span><span class="line"><span class="cl"><span class="c1"># 添加下面的内容</span>
</span></span><span class="line"><span class="cl">vm.swappiness<span class="o">=</span><span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sysctl -p /etc/sysctl.d/k8s.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>让修改生效。</p>
<p><strong>方法二</strong></p>
<p>由于主机上可能还需要运行其他的服务，因此直接关闭swap可能会对其他服务产生影响。
可以通过修改 kubelet 的启动参数来去掉这个限制。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vi /etc/sysconfig/kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><p>加入以下内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">KUBELET_EXTRA_ARGS</span><span class="o">=</span>--fail-swap-on<span class="o">=</span><span class="nb">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="安装docker">安装Docker</h3>
<h4 id="centos">CentOS</h4>
<blockquote>
<p>Kubernetes 1.12已经针对Docker的1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06等版本做了验证，需要注意 Kubernetes 1.12 最低支持的Docker版本是 1.11.1。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 首先确保 docker 环境干净</span>
</span></span><span class="line"><span class="cl">sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate
</span></span><span class="line"><span class="cl">sudo yum remove docker-logrotate docker-selinux docker-engine-selinux docker-engine
</span></span><span class="line"><span class="cl"><span class="c1"># 管理 yum 源</span>
</span></span><span class="line"><span class="cl">sudo yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span class="line"><span class="cl"><span class="c1"># 添加 yum 源</span>
</span></span><span class="line"><span class="cl">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span class="line"><span class="cl"><span class="c1"># 更新 yum 索引</span>
</span></span><span class="line"><span class="cl">sudo yum makecache fast
</span></span><span class="line"><span class="cl"><span class="c1"># 安装 docker</span>
</span></span><span class="line"><span class="cl">$ yum install docker-ce
</span></span><span class="line"><span class="cl"><span class="c1"># 启动 docker</span>
</span></span><span class="line"><span class="cl">$ systemctl start docker
</span></span><span class="line"><span class="cl"><span class="c1"># 将 docker 添加到开机启动服务</span>
</span></span><span class="line"><span class="cl">$ systemctl <span class="nb">enable</span> docker
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果需要安装特定的 Docker 版本，执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查找指定 Docker-CE 的版本</span>
</span></span><span class="line"><span class="cl">yum list docker-ce.x86_64 --showduplicates <span class="p">|</span> sort -r
</span></span><span class="line"><span class="cl"><span class="c1"># 安装指定版本的Docker-CE</span>
</span></span><span class="line"><span class="cl">sudo yum -y install docker-ce-<span class="o">[</span>VERSION<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ubuntu">Ubuntu</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 安装系统工具</span>
</span></span><span class="line"><span class="cl">sudo apt-get update
</span></span><span class="line"><span class="cl">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common
</span></span><span class="line"><span class="cl"><span class="c1"># 安装GPG证书</span>
</span></span><span class="line"><span class="cl">curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key add -
</span></span><span class="line"><span class="cl"><span class="c1"># 写入软件源信息</span>
</span></span><span class="line"><span class="cl">sudo add-apt-repository <span class="s2">&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span class="k">$(</span>lsb_release -cs<span class="k">)</span><span class="s2"> stable&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 更新并安装 Docker-CE</span>
</span></span><span class="line"><span class="cl">sudo apt-get -y update
</span></span><span class="line"><span class="cl">sudo apt-get -y install docker-ce
</span></span><span class="line"><span class="cl"><span class="c1"># 查找指定版本</span>
</span></span><span class="line"><span class="cl">apt-cache madison docker-ce
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="可能遇到的问题">可能遇到的问题</h4>
<h5 id="执行-yum-install-docker-ce-出现-errno-256-no-more-mirrors-to-try">执行 <code>yum install docker-ce</code> 出现 <code>[Errno 256] No more mirrors to try</code></h5>
<p>执行以下命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ yum clean all
</span></span><span class="line"><span class="cl">$ yum makecache fast
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="package-docker-ce-selinux-is-obsoleted-by-docker-ce-but-obsoleting-package-does-not-provide-for-requirements"><code>Package docker-ce-selinux is obsoleted by docker-ce, but obsoleting package does not provide for requirements</code></h5>
<p>错误原因：</p>
<blockquote>
<p>on a new system with yum repo defined, forcing older version and ignoring obsoletes introduced by 17.06.0</p>
</blockquote>
<p>通过执行以下命令可以解决该问题</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ yum install --setopt<span class="o">=</span><span class="nv">obsoletes</span><span class="o">=</span><span class="m">0</span> docker-ce-17.03.2.ce docker-ce-selinux-17.03.2.ce
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-kubeadm-部署">使用 kubeadm 部署</h3>
<h4 id="安装kubeadmkubelet和kubectl">安装kubeadm，kubelet和kubectl</h4>
<p><strong>非国内源安装</strong></p>
<p>如果你的网络能够访问 <code>packages.cloud.google.com</code>，可以采用该种方式进行安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">yum install -y kubelet kubeadm kubectl --disableexcludes<span class="o">=</span>kubernetes
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>运行 <code>kubelet --help</code> 会发现之前大多数的命令行参数配置都已经 DEPRECATED 了。</p>
<p>目前官方推荐使用 &ndash;config 来指定配置文件，并在配置文件中指定相关内容。具体内容可以参考 <a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/">Set Kubelet parameters via a config file</a>.</p>
</blockquote>
<p><strong>国内源安装（阿里云）</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">yum install -y kubelet kubeadm kubectl --disableexcludes<span class="o">=</span>kubernetes
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="准备镜像">准备镜像</h4>
<p>由于 Kubernetes 的安装过程中，相关组件的镜像都是托管在 Google Container Registry 上的。国内镜像加速通常都是针对 DockerHub 来的，因此国内的服务器无法直接通过 gcr 来安装镜像。</p>
<p>因此最好的解决方法就是在可访问 <code>gcr.io/google-containers</code> 的国外节点中，把 gcr.io 的镜像拉到可访问的镜像仓库中，比如 DockerHub 或者阿里云等等。</p>
<h5 id="创建仓库">创建仓库</h5>
<p>本文使用阿里云的镜像仓库作为示例。
阿里云镜像仓库地址：<code>https://cr.console.aliyun.com/cn-shanghai/repositories</code></p>
<p>创建步骤：</p>
<ol>
<li>点击创建镜像仓库按钮</li>
<li>填写相关的表单内容
<img src="https://i.loli.net/2018/11/22/5bf66cb9dfe2d.jpg" alt="repo.jpg">
3.选择本地仓库</li>
</ol>
<p>这样我们就能够成功创建一个我们自己的公开的镜像仓库。</p>
<p>地址类似这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">registry.cn-shanghai.aliyuncs.com/cxyfreedom/k8s
</span></span></code></pre></td></tr></table>
</div>
</div><p>登录方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker login --username=&lt;username&gt; registry.cn-shanghai.aliyuncs.com
</span></span></code></pre></td></tr></table>
</div>
</div><p>登录成功的话，会返回 <code>Login Succeeded</code></p>
<h5 id="获取版本号">获取版本号</h5>
<p>获取每个版本的镜像版本号可以通过 <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/#custom-images">Overview of kubeadm</a> 所写内容来调整自己脚本中的一些参数。</p>
<p>比如我现在要获取 <code>1.12.2</code> 版本的所有相关镜像可以通过如下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubeadm config images list
</span></span></code></pre></td></tr></table>
</div>
</div><p>输出结果为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">k8s.gcr.io/kube-apiserver:v1.12.2
</span></span><span class="line"><span class="cl">k8s.gcr.io/kube-controller-manager:v1.12.2
</span></span><span class="line"><span class="cl">k8s.gcr.io/kube-scheduler:v1.12.2
</span></span><span class="line"><span class="cl">k8s.gcr.io/kube-proxy:v1.12.2
</span></span><span class="line"><span class="cl">k8s.gcr.io/pause:3.1
</span></span><span class="line"><span class="cl">k8s.gcr.io/etcd:3.2.24
</span></span><span class="line"><span class="cl">k8s.gcr.io/coredns:1.2.2
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="准备镜像仓库">准备镜像仓库</h5>
<p><strong>方法一：利用脚本推送镜像</strong></p>
<p>在国外节点上面创建一个脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim push.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -o errexit
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o nounset
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">KUBE_VERSION</span><span class="o">=</span>v1.12.2
</span></span><span class="line"><span class="cl"><span class="nv">KUBE_PAUSE_VERSION</span><span class="o">=</span>3.1
</span></span><span class="line"><span class="cl"><span class="nv">ETCD_VERSION</span><span class="o">=</span>3.2.24
</span></span><span class="line"><span class="cl"><span class="nv">DNS_VERSION</span><span class="o">=</span>1.2.2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">GCR_URL</span><span class="o">=</span>gcr.io/google-containers
</span></span><span class="line"><span class="cl"><span class="nv">ALIYUN_URL</span><span class="o">=</span>registry.cn-shanghai.aliyuncs.com/cxyfreedom
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">images</span><span class="o">=(</span>kube-proxy-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">kube-scheduler-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">kube-controller-manager-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">kube-apiserver-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">pause:<span class="si">${</span><span class="nv">KUBE_PAUSE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd-amd64:<span class="si">${</span><span class="nv">ETCD_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">coredns:<span class="si">${</span><span class="nv">DNS_VERSION</span><span class="si">}</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> imageName in <span class="si">${</span><span class="nv">images</span><span class="p">[@]</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">  docker pull <span class="nv">$GCR_URL</span>/<span class="nv">$imageName</span>
</span></span><span class="line"><span class="cl">  docker tag <span class="nv">$GCR_URL</span>/<span class="nv">$imageName</span> <span class="nv">$ALIYUN_URL</span>/<span class="nv">$imageName</span>
</span></span><span class="line"><span class="cl">  docker push <span class="nv">$ALIYUN_URL</span>/<span class="nv">$imageName</span>
</span></span><span class="line"><span class="cl">  docker rmi <span class="nv">$ALIYUN_URL</span>/<span class="nv">$imageName</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>成功运行脚本后，在我们自己的阿里云镜像仓库就存在了对应的包。</p>
<p><strong>方法二：使用别人已经做好的镜像仓库</strong></p>
<p>国内目前做的比较好的 k8s 的镜像仓库是安家的。</p>
<p><a href="https://anjia0532.github.io/2017/11/15/gcr-io-image-mirror/">Google Container Registry(gcr.io) 中国可用镜像(长期维护)</a>
<a href="https://github.com/anjia0532/gcr.io_mirror">安家的Github</a>
<a href="https://hub.docker.com/u/anjia0532/">DockerHub仓库</a></p>
<h4 id="获取镜像">获取镜像</h4>
<p>在 master 节点上面创建一个脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim pull.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nv">KUBE_VERSION</span><span class="o">=</span>v1.12.2
</span></span><span class="line"><span class="cl"><span class="nv">KUBE_PAUSE_VERSION</span><span class="o">=</span>3.1
</span></span><span class="line"><span class="cl"><span class="nv">ETCD_VERSION</span><span class="o">=</span>3.2.24
</span></span><span class="line"><span class="cl"><span class="nv">DNS_VERSION</span><span class="o">=</span>1.2.2
</span></span><span class="line"><span class="cl"><span class="nv">username</span><span class="o">=</span>registry.cn-shanghai.aliyuncs.com/cxyfreedom
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">images</span><span class="o">=(</span>kube-proxy-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">kube-scheduler-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">kube-controller-manager-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">kube-apiserver-amd64:<span class="si">${</span><span class="nv">KUBE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">pause:<span class="si">${</span><span class="nv">KUBE_PAUSE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">etcd-amd64:<span class="si">${</span><span class="nv">ETCD_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">coredns:<span class="si">${</span><span class="nv">DNS_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> image in <span class="si">${</span><span class="nv">images</span><span class="p">[@]</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    docker pull <span class="si">${</span><span class="nv">username</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    docker tag <span class="si">${</span><span class="nv">username</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image</span><span class="si">}</span> k8s.gcr.io/<span class="si">${</span><span class="nv">image</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#docker tag ${username}/${image} gcr.io/google_containers/${image}</span>
</span></span><span class="line"><span class="cl">    docker rmi <span class="si">${</span><span class="nv">username</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行脚本成功以后,通过 <code>docker images</code> 可以看到需要的镜像应该都正常被拉取下来。</p>
<h4 id="使用-kubeadm-init-初始化集群只在主节点执行">使用 kubeadm init 初始化集群（只在主节点执行）</h4>
<p>首先需要确保在主节点环境中没有设置 <code>http_proxy</code> 和 <code>https_proxy</code></p>
<p>然后执行以下命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubeadm init --kubernetes-version<span class="o">=</span>v1.12.2 --pod-network-cidr<span class="o">=</span>10.244.0.0/16 --apiserver-advertise-address<span class="o">=</span>&lt;host ip&gt; --ignore-preflight-errors<span class="o">=</span>Swap --token-ttl <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>常见 Optional</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">--apiserver-advertise-address: Api server 服务 IP 位址
</span></span><span class="line"><span class="cl">--apiserver-bind-port: Api server 服务端口号，默认 <span class="m">6443</span>
</span></span><span class="line"><span class="cl">--pod-network-cidr: Pod 的虚拟 IP 范围 <span class="o">(</span>CIDR<span class="o">)</span>
</span></span><span class="line"><span class="cl">--kubernetes-version: 指定 Kubernetes 版本，建议 1.6+
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为选择 flannel 作为 Pod 的网络插件，所以在命令中需要指定 <code>--pod-network-cidr=10.244.0.0/16</code>。</p>
<p><code>--apiserver-advertize-address</code>是apiserver的通信地址，一般使用的是 master 节点的 IP 地址。</p>
<p>初始化成功以后，会提供节点加入 k8s 集群的 token。默认 token 的有效期是 24 小时。过期后需要重新生成，比较麻烦，设置 <code>--token-ttl 0</code> 表示永不过期。</p>
<p>初始化成功示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Your Kubernetes master has initialized successfully!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mkdir -p $HOME/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="cl">Run &#34;kubectl apply -f [podnetwork].yaml&#34; with one of the options listed at:
</span></span><span class="line"><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can now join any number of machines by running the following on each node
</span></span><span class="line"><span class="cl">as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  kubeadm join 10.0.0.100:6443 --token q5egpf.zjw0a7bgnd11dw6d --discovery-token-ca-cert-hash sha256:29118e58fcd32d3234fd53584d376c05c7d36d4e1be011dbac92260cbd007963
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="可能遇到的问题-1">可能遇到的问题</h4>
<h5 id="卡在-preflightimages">卡在 preflight/images</h5>
<p>由于在 init 的过程中，k8s 会自动从 google 服务器中拉取相关的 docker 镜像。首先会去检查代理服务器，确定和 kube-apiserver 的 https 连接方式，如果有代理，会发出警告。</p>
<p>如果一直卡在 preflight/images</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[preflight/images] Pulling images required for setting up a Kubernetes cluster
</span></span><span class="line"><span class="cl">[preflight/images] This might take a minute or two, depending on the speed of your internet connection
</span></span><span class="line"><span class="cl">[preflight/images] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以尝试上面小节的方式，事先准备好相关的镜像。</p>
<h5 id="warning-httpproxycidr">WARNING HTTPProxyCIDR</h5>
<p>如果遇到如下的警告</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> [WARNING HTTPProxy]: Connection to &#34;https://10.0.0.10&#34; uses proxy &#34;http://127.0.0.1:8118&#34;. If that is not intended, adjust your proxy settings
</span></span><span class="line"><span class="cl">    [WARNING HTTPProxyCIDR]: connection to &#34;10.96.0.0/12&#34; uses proxy &#34;http://127.0.0.1:8118&#34;. This may lead to malfunctional cluster setup. Make sure that Pod and Services IP ranges specified correctly as exceptions in proxy configuration
</span></span><span class="line"><span class="cl">    [WARNING HTTPProxyCIDR]: connection to &#34;10.244.0.0/16&#34; uses proxy &#34;http://127.0.0.1:8118&#34;. This may lead to malfunctional cluster setup. Make sure that Pod and Services IP ranges specified correctly as exceptions in proxy configuration
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么需要设置 <code>no_proxy</code>。
执行 <code>vim /etc/profile</code>，在最后添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">no_proxy</span><span class="o">=</span><span class="s1">&#39;127.0.0.1,10.0.0.100,k8s.gcr.io,10.96.0.0/12,10.244.0.0/16&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后执行 <code>source /etc/profile</code> 使命令生效</p>
<h5 id="failed-to-read-kubelet-config-file-varlibkubeletconfigyaml">failed to read kubelet config file &ldquo;/var/lib/kubelet/config.yaml&rdquo;</h5>
<p>如果遇到这种问题，大多数情况是因为在 <code>kubeadm init</code> 之前就运行了 <code>systemctl start kubelet</code>。</p>
<p>解决方法就是在成功运行 <code>kubeadm init</code> 之后，再运行 <code>systemctl start kubelet</code>。</p>
<h5 id="cni-config-uninitialized">cni config uninitialized</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Unable to update cni config: No networks found in /etc/cni/net.d
</span></span><span class="line"><span class="cl">KubeletNotReady runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果遇到上述错误，原因是因为 kubelet 配置了 <code>network-plugin=cni</code> ，但是还未安装，所以状态是 NotReady，也有可能是国内节点无法获取 flannel 这个镜像，如果不想看到这个报错或者不需要该网络，可以通过修改配置的方式或者提前拉取镜像。</p>
<p><strong>方法一：拉取镜像（推荐）</strong></p>
<p>在国外节点上面创建一个脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim push_pod.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -o errexit
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o nounset
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">ALIYUN_URL</span><span class="o">=</span>registry.cn-shanghai.aliyuncs.com/cxyfreedom
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker pull quay.io/coreos/flannel:v0.10.0-amd64
</span></span><span class="line"><span class="cl">docker tag quay.io/coreos/flannel:v0.10.0-amd64 <span class="si">${</span><span class="nv">ALIYUN_URL</span><span class="si">}</span>/flannel:v0.10.0-amd64
</span></span><span class="line"><span class="cl">docker push <span class="si">${</span><span class="nv">ALIYUN_URL</span><span class="si">}</span>/flannel:v0.10.0-amd64
</span></span><span class="line"><span class="cl">docker rmi quay.io/coreos/flannel:v0.10.0-amd64
</span></span><span class="line"><span class="cl">docker rmi <span class="si">${</span><span class="nv">ALIYUN_URL</span><span class="si">}</span>/flannel:v0.10.0-amd64
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行 <code>sh push_pod.sh</code></p>
<p>然后在国内节点也创建一个脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim pull_pod.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">set</span> -o errexit
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o nounset
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">ALIYUN_URL</span><span class="o">=</span>registry.cn-shanghai.aliyuncs.com/cxyfreedom
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker pull <span class="si">${</span><span class="nv">ALIYUN_URL</span><span class="si">}</span>/flannel:v0.10.0-amd64
</span></span><span class="line"><span class="cl">docker tag <span class="si">${</span><span class="nv">ALIYUN_URL</span><span class="si">}</span>/flannel:v0.10.0-amd64 quay.io/coreos/flannel:v0.10.0-amd64
</span></span><span class="line"><span class="cl">docker rmi <span class="si">${</span><span class="nv">ALIYUN_URL</span><span class="si">}</span>/flannel:v0.10.0-amd64
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行 <code>sh pull_pod.sh</code></p>
<p><strong>方法二：修改配置文件</strong></p>
<p>执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除最后一行中的 <code>$KUBELET_NETWORK_ARGS</code>。
最后，重启 kubelet 并重新初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">systemctl <span class="nb">enable</span> kubelet <span class="o">&amp;&amp;</span> systemctl start kubelet
</span></span><span class="line"><span class="cl">kubeadm reset
</span></span><span class="line"><span class="cl">kubeadm init --kubernetes-version<span class="o">=</span>v1.12.2 --pod-network-cidr<span class="o">=</span>10.244.0.0/16 --apiserver-advertise-address<span class="o">=</span>&lt;host ip&gt; --token-ttl <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="nethttp-tls-handshake-timeout">net/http: TLS handshake timeout</h5>
<p>如果比如请求 <code>kubeadm version</code> 告诉端口无法连接、超时或者拒绝连接等。一般来说是因为我们设置了 <code>http_proxy</code> 和 <code>https_proxy</code> 做代理翻墙导致无法访问自身和内网。</p>
<p>执行 <code>vim /etc/profile</code>，在最后添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">no_proxy</span><span class="o">=</span><span class="s1">&#39;127.0.0.1,10.0.0.10,k8s.gcr.io,10.96.0.0/12,10.244.0.0/16&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果有多个集群，需要把集群中每一个节点的IP也添加上去。</p>
<p>最后执行 <code>source /etc/profile</code> 使命令生效。</p>
<p>如果还是失败，可以重新进行初始化</p>
<p>简便</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubeadm reset
</span></span><span class="line"><span class="cl">kubeadm init
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubeadm reset
</span></span><span class="line"><span class="cl">ifconfig cni0 down
</span></span><span class="line"><span class="cl">ip link delete cni0
</span></span><span class="line"><span class="cl">ifconfig flannel.1 down
</span></span><span class="line"><span class="cl">ip link delete flannel.1
</span></span><span class="line"><span class="cl">rm -rf /var/lib/cni/
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于初始化中的错误可以另外起一个终端来进行跟踪</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">journalctl -f -u kubelet.service
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="正确输出">正确输出</h4>
<p>如果 <code>kubeadm init</code> 后没有出错，正常情况下会返回类似如下结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Your Kubernetes master has initialized successfully!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="cl">  mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="cl">Run <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class="line"><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can now join any number of machines by running the following on each node
</span></span><span class="line"><span class="cl">as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  kubeadm join 10.0.0.10:6443 --token 2g0sf1.17rr8z5kvrsg12ha --discovery-token-ca-cert-hash sha256:69c0763f251e09db08a650ae2c3677f501ebbb7a9fed8961b8bf376a4c8c8ed2
</span></span></code></pre></td></tr></table>
</div>
</div><p>关键点：</p>
<ul>
<li>生成的 token 需要记录下来，后续使用 <code>kubeadm join</code> 往集群中添加节点需要使用</li>
<li>下面的命令是为了配置常规用户如何使用 kubectl 来访问集群</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="安装-pod-network只在主节点执行">安装 Pod Network（只在主节点执行）</h4>
<p>执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span class="line"><span class="cl">kubectl apply -f kube-flannel.yml
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以通过 cat 来查看 kue-flannel.yml 这个文件里的 flannel 的镜像版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat kube-flannel.yml<span class="p">|</span>grep quay.io/coreos/flannel
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果 Node 有多个网卡的话，目前需要在 <code>kube-flannel.yml</code>  中使用 <code>—iface</code> 参数指定集群主机内网网卡的名称，否则可能会出现 dns 无法解析。需要将 <code>kube-flannel.yml</code> 下载到本地，flanneld 启动参数加上 <code>—iface=</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">containers:
</span></span><span class="line"><span class="cl">      - name: kube-flannel
</span></span><span class="line"><span class="cl">        image: quay.io/coreos/flannel:v0.10.0-amd64
</span></span><span class="line"><span class="cl">        command:
</span></span><span class="line"><span class="cl">        - /opt/bin/flanneld
</span></span><span class="line"><span class="cl">        args:
</span></span><span class="line"><span class="cl">        - --ip-masq
</span></span><span class="line"><span class="cl">        - --kube-subnet-mgr
</span></span><span class="line"><span class="cl">        - --iface<span class="o">=</span>eth1
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>kubectl get pod --all-namespaces -o wide</code> 确保所有的 Pod 都处于 Running 状态。
如果有状态错误的 Pod，可以通过 <code>kubectl describe pod &lt;pod-name&gt; -n kube-system</code> 来查看错误原因。</p>
<h4 id="master-节点参与工作负载">master 节点参与工作负载</h4>
<p>默认情况下 master 节点不能被用来部署 pod。如果想让 master 节点也能够部署 pod，执行以下命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl taint nodes &lt;node name&gt; &lt;node label&gt;:NoSchedule-
</span></span></code></pre></td></tr></table>
</div>
</div><p>示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get nodes --show-labels
</span></span><span class="line"><span class="cl">NAME                 STATUS     ROLES     AGE       VERSION   LABELS
</span></span><span class="line"><span class="cl">k8s-master   Ready    master   16m   v1.12.2   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/hostname<span class="o">=</span>k8s-master,node-role.kubernetes.io/master<span class="o">=</span>
</span></span><span class="line"><span class="cl">$ kubectl taint nodes k8s-master,node-role.kubernetes.io/master:NoSchedule-
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="从集群中移除-node">从集群中移除 Node</h4>
<p>假设现在集群中有一个节点叫做 <code>node1</code>，在 master 节点上执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl drain node1 --delete-local-data --force --ignore-daemonsets
</span></span><span class="line"><span class="cl">kubectl delete node node1
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后在 <code>node1</code> 上执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubeadm reset
</span></span><span class="line"><span class="cl">ifconfig cni0 down
</span></span><span class="line"><span class="cl">ip link delete cni0
</span></span><span class="line"><span class="cl">ifconfig flannel.1 down
</span></span><span class="line"><span class="cl">ip link delete flannel.1
</span></span><span class="line"><span class="cl">rm -rf /var/lib/cni/
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="安装常用组件">安装常用组件</h3>
<h4 id="安装-dashboard-监控界面只在主节点执行">安装 dashboard 监控界面（只在主节点执行）</h4>
<p><strong>所需要的镜像</strong></p>
<p><code>k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.0</code></p>
<p>执行命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -O https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
</span></span><span class="line"><span class="cl">kubectl create -f kubernetes-dashboard.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果执行成功，会输出以下内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">secret/kubernetes-dashboard-certs created
</span></span><span class="line"><span class="cl">serviceaccount/kubernetes-dashboard created
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
</span></span><span class="line"><span class="cl">deployment.apps/kubernetes-dashboard created
</span></span><span class="line"><span class="cl">service/kubernetes-dashboard created
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于网络原因，所以我们可以事先先把镜像来去下来，使用本地的镜像来部署。
在 <code>kubernetes-dashboard.yaml</code> 中找到 <code>image</code> 那一行，在下面添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">imagePullPolicy: Never
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>imagePullPolicy</code> 可选值有：<code>Always</code>、<code>IfNotPresent</code>、<code>Never</code>。</p>
<p>查看 dashboard 的镜像是否正常运行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pod --namespace=kube-system</span>
</span></span><span class="line"><span class="cl">NAME                                         READY     STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-78fcdf6894-rt2qh                     1/1       Running   <span class="m">0</span>          7h
</span></span><span class="line"><span class="cl">coredns-78fcdf6894-zb4jh                     1/1       Running   <span class="m">0</span>          7h
</span></span><span class="line"><span class="cl">etcd-master.example.com                      1/1       Running   <span class="m">0</span>          5h
</span></span><span class="line"><span class="cl">kube-apiserver-master.example.com            1/1       Running   <span class="m">0</span>          5h
</span></span><span class="line"><span class="cl">kube-controller-manager-master.example.com   1/1       Running   <span class="m">0</span>          5h
</span></span><span class="line"><span class="cl">kube-flannel-ds-amd64-4vbqk                  1/1       Running   <span class="m">0</span>          5h
</span></span><span class="line"><span class="cl">kube-flannel-ds-amd64-fnkdr                  1/1       Running   <span class="m">0</span>          7h
</span></span><span class="line"><span class="cl">kube-proxy-97s6f                             1/1       Running   <span class="m">0</span>          7h
</span></span><span class="line"><span class="cl">kube-proxy-qkjrr                             1/1       Running   <span class="m">0</span>          5h
</span></span><span class="line"><span class="cl">kube-scheduler-master.example.com            1/1       Running   <span class="m">0</span>          5h
</span></span><span class="line"><span class="cl">kubernetes-dashboard-6948bdb78-grshl         1/1       Running   <span class="m">0</span>          3m
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="访问方式">访问方式</h5>
<p><strong>1. kubectl proxy</strong></p>
<p>如果需要本地访问 dashboard，执行 <code>kubectl proxy</code> 即可。然后通过 <code>http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy</code> 就能访问 dashboard 的 UI 了。</p>
<p><img src="https://i.loli.net/2018/11/22/5bf66cbd8c4c7.jpg" alt="k8s-dashboard.jpg"></p>
<p>可以使用 <code>--address</code> 和 <code>--accept-hosts</code> 参数来允许外部访问：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl proxy --address<span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span>  --accept-hosts<span class="o">=</span><span class="s1">&#39;^*$&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>备注：<strong>虽然从其它地址可以访问到该界面，但是无法登录，因为 dashboard 只允许本地进行 HTTP 连接访问，其它地址只允许使用 HTTPS</strong>。</p>
</blockquote>
<p><strong>2. NodePort</strong></p>
<p>该方法只建议在开发环境进行使用</p>
<p>编辑 <code>kubernetes-dashboard.yaml</code>，将 <code>type: ClusterIP</code> 改为 <code>type: NodePort</code>。如果没有，则直接添加该语句。</p>
<p>通过下面的语句可以查看对外的端口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl -n kube-system get service kubernetes-dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意事项：由于证书问题，无法直接访问，需要在部署的同时指定有效的证书才可以访问。因此，在生产环境中，不建议使用 NodePort 的方式。</p>
</blockquote>
<p><strong>3. API Server</strong></p>
<p>访问地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">https://&lt;master-ip&gt;:&lt;apiserver-port&gt;/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>client-certificate-data</code> 和 <code>client-key-data</code> 来生成一个p12文件，执行命令如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 生成client-certificate-data</span>
</span></span><span class="line"><span class="cl">grep <span class="s1">&#39;client-certificate-data&#39;</span> ~/.kube/config <span class="p">|</span> head -n <span class="m">1</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> base64 -d &gt;&gt; kubecfg.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 生成client-key-data</span>
</span></span><span class="line"><span class="cl">grep <span class="s1">&#39;client-key-data&#39;</span> ~/.kube/config <span class="p">|</span> head -n <span class="m">1</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> base64 -d &gt;&gt; kubecfg.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 生成p12</span>
</span></span><span class="line"><span class="cl">openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name <span class="s2">&#34;kubernetes-client&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意事项：对于生产系统，我们应该为每个用户应该生成自己的证书，因为不同的用户会有不同的命名空间访问权限。</p>
</blockquote>
<h5 id="身份认证">身份认证</h5>
<p>登录 dashboard 的时候支持 kubeconfig 和 token 两种认证方式，kubeconfig 中也依赖 token，因此生成 token 是必不可少的。</p>
<p><strong>使用 kubeconfig</strong></p>
<p>默认的 kubeconfig 在 <code>$HOME/.kube/config</code> 下，也可以创建我们自己的 kubeconfig 文件。</p>
<blockquote>
<p>生成的 kubeconfig 文件中没有 token 字段，需要在最后手动添加。</p>
</blockquote>
<p><strong>创建 token</strong></p>
<p>需要创建一个用户并将 admin 角色进行绑定，这样就能赋予其管理员权限。</p>
<p>创建一个 yaml 文件叫做 <code>kubernetes-dashboard-rbac.yaml</code>（文件名可以随便取），内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后执行以下命令即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create -f kubernetes-dashboard-rbac.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后获取我们需要的 token</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl -n kube-system describe secret <span class="k">$(</span>kubectl -n kube-system get secret <span class="p">|</span> grep admin-user <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="参考资料">参考资料</h3>
<ul>
<li><a href="https://blog.frognew.com/2018/10/kubeadm-install-kubernetes-1.12.html#33-%E4%BD%BF%E7%94%A8helm%E9%83%A8%E7%BD%B2dashboard">使用kubeadm安装Kubernetes 1.12</a></li>
<li><a href="https://www.cnblogs.com/RainingNight/p/deploying-k8s-dashboard-ui.html">kubernetes-dashboard(1.8.3)部署与踩坑</a></li>
<li><a href="https://jimmysong.io/posts/kubernetes-dashboard-upgrade/">Kubernetes Dashboard中的身份认证详解</a></li>
</ul>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">CxyFreedom</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-11-22 17:26
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/cxyfreedom/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat.jpg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/Kubernetes/">Kubernetes</a>
          <a href="/tags/kubeadm/">kubeadm</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/python-custom-logger/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">解析自定义 Logger 后会打印第三方库中 Logger 日志的原因</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/kubernetes-helm-installation/">
            <span class="next-text nav-default">Helm 使用教程</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="cxyfreedom/blog"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:cxydfreedom@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/cxyfreedom" class="iconfont icon-github" title="github"></a>
      <a href="http://weibo.com/207071991" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://reishin.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>CxyFreedom</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "en".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script><script></script><script src="https://cdn.jsdelivr.net/npm/raphael@2.2.7/raphael.min.js" integrity="sha256-67By+NpOtm9ka1R6xpUefeGOY8kWWHHRAKlvaTJ7ONI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/flowchart.js@1.8.0/release/flowchart.min.js" integrity="sha256-zNGWjubXoY6rb5MnmpBNefO0RgoVYfle9p0tvOQM+6k=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-83044258-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
